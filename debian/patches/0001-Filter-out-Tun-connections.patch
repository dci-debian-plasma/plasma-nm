From c5eb19bb44c8b10d848628557405b597b680bbe8 Mon Sep 17 00:00:00 2001
From: Jan Grulich <jgrulich@redhat.com>
Date: Mon, 4 Apr 2016 09:33:56 +0200
Subject: [PATCH] Filter out Tun connections

---
 CMakeLists.txt                     | 2 +-
 kded/notification.cpp              | 6 ++++++
 libs/declarative/networkstatus.cpp | 5 +++++
 libs/models/appletproxymodel.cpp   | 5 +++++
 libs/models/editorproxymodel.cpp   | 6 +++++-
 5 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 4ee1a7b..dba4024 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -32,7 +32,7 @@ find_package(KF5 REQUIRED
     I18n WindowSystem Service Completion WidgetsAddons KIO CoreAddons Wallet ItemViews XmlGui
     ConfigWidgets IconThemes Solid DBusAddons Notifications Plasma Declarative Init KDELibs4Support)
 
-find_package(KF5NetworkManagerQt REQUIRED 5.14.0)
+find_package(KF5NetworkManagerQt REQUIRED 5.21.0)
 
 find_package(KF5ModemManagerQt 5.14.0)
 set_package_properties(KF5ModemManagerQt PROPERTIES
diff --git a/kded/notification.cpp b/kded/notification.cpp
index c461228..e3d19ad 100644
--- a/kded/notification.cpp
+++ b/kded/notification.cpp
@@ -367,7 +367,13 @@ void Notification::addActiveConnection(const NetworkManager::ActiveConnection::P
                ac->type() != NetworkManager::ConnectionSettings::Generic &&
                ac->type() != NetworkManager::ConnectionSettings::Infiniband &&
                ac->type() != NetworkManager::ConnectionSettings::Team &&
+#if NM_CHECK_VERSION(1, 1, 92)
+               ac->type() != NetworkManager::ConnectionSettings::Vlan &&
+               ac->type() != NetworkManager::ConnectionSettings::Tun) {
+#else
                ac->type() != NetworkManager::ConnectionSettings::Vlan) {
+#endif
+
 #else
     } else if (ac->type() != NetworkManager::ConnectionSettings::Bond &&
                ac->type() != NetworkManager::ConnectionSettings::Bridge &&
diff --git a/libs/declarative/networkstatus.cpp b/libs/declarative/networkstatus.cpp
index c1731d6..3dd38e2 100644
--- a/libs/declarative/networkstatus.cpp
+++ b/libs/declarative/networkstatus.cpp
@@ -129,7 +129,12 @@ void NetworkStatus::changeActiveConnections()
             active->type() != NetworkManager::ConnectionSettings::Generic &&
             active->type() != NetworkManager::ConnectionSettings::Infiniband &&
             active->type() != NetworkManager::ConnectionSettings::Team &&
+#if NM_CHECK_VERSION(1, 1, 92)
+            active->type() != NetworkManager::ConnectionSettings::Vlan &&
+            active->type() != NetworkManager::ConnectionSettings::Tun) {
+#else
             active->type() != NetworkManager::ConnectionSettings::Vlan) {
+#endif
 #else
         if (!active->devices().isEmpty() &&
             active->type() != NetworkManager::ConnectionSettings::Bond &&
diff --git a/libs/models/appletproxymodel.cpp b/libs/models/appletproxymodel.cpp
index d1fc812..82346c6 100644
--- a/libs/models/appletproxymodel.cpp
+++ b/libs/models/appletproxymodel.cpp
@@ -108,7 +108,12 @@ bool AppletProxyModel::filterAcceptsRow(int source_row, const QModelIndex& sourc
         type == NetworkManager::ConnectionSettings::Generic ||
         type == NetworkManager::ConnectionSettings::Infiniband ||
         type == NetworkManager::ConnectionSettings::Team ||
+#if NM_CHECK_VERSION(1, 1, 92)
+        type == NetworkManager::ConnectionSettings::Vlan ||
+        type == NetworkManager::ConnectionSettings::Tun) {
+#else
         type == NetworkManager::ConnectionSettings::Vlan) {
+#endif
         return false;
     }
 #endif
diff --git a/libs/models/editorproxymodel.cpp b/libs/models/editorproxymodel.cpp
index 66ff767..1822a24 100644
--- a/libs/models/editorproxymodel.cpp
+++ b/libs/models/editorproxymodel.cpp
@@ -52,8 +52,12 @@ bool EditorProxyModel::filterAcceptsRow(int source_row, const QModelIndex& sourc
     if (type == NetworkManager::ConnectionSettings::Generic) {
         return false;
     }
+#if NM_CHECK_VERSION(1, 1, 92)
+    if (type == NetworkManager::ConnectionSettings::Tun) {
+        return false;
+    }
+#endif
 #endif
-
 
     NetworkModelItem::ItemType itemType = (NetworkModelItem::ItemType)sourceModel()->data(index, NetworkModel::ItemTypeRole).toUInt();
     if (itemType == NetworkModelItem::AvailableAccessPoint || itemType == NetworkModelItem::AvailableNsp) {
-- 
2.7.4

